{% load humanize %}
<div class="userflow-tab">
    <h3 class="mb-4"><i class="bi bi-diagram-3"></i> User Flow Analysis</h3>
    
    <div class="row mb-4">
        <!-- User Flow Stats Cards -->
        <div class="col-md-3 mb-3">
            <div class="card bg-black border-primary">
                <div class="card-body">
                    <h6 class="card-title">Total Sessions</h6>
                    <h3 class="card-text">{{ userflow.total_sessions|intcomma }}</h3>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card bg-black border-info">
                <div class="card-body">
                    <h6 class="card-title">Avg. Path Length</h6>
                    <h3 class="card-text">{{ userflow.avg_path_length|floatformat:1 }}</h3>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card bg-black border-success">
                <div class="card-body">
                    <h6 class="card-title">Conversion Rate</h6>
                    <h3 class="card-text">{{ userflow.conversion_rate|floatformat:1 }}%</h3>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card bg-black border-warning">
                <div class="card-body">
                    <h6 class="card-title">Avg. Duration</h6>
                    <h3 class="card-text">{{ userflow.avg_duration|floatformat:0 }}s</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Flow Visualization -->
    <div class="row">
        <div class="col-md-8 mb-4">
            <div class="card bg-black border-secondary">
                <div class="card-header">
                    <h5>Common User Paths</h5>
                </div>
                <div class="card-body">
                    <div id="sankeyDiagram" style="height: 400px;"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4 mb-4">
            <div class="card bg-black border-secondary">
                <div class="card-header">
                    <h5>Top Exit Pages</h5>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for page in userflow.top_exit_pages %}
                        <div class="list-group-item bg-dark d-flex justify-content-between align-items-center">
                            <span>{{ page.path }}</span>
                            <span class="badge bg-primary rounded-pill">{{ page.count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Path Analysis Table -->
    <div class="card bg-black border-secondary">
        <div class="card-header">
            <h5>Recent User Sessions</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-dark table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Session ID</th>
                            <th>Path Sequence</th>
                            <th>Duration</th>
                            <th>Exit Page</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for flow in userflow.recent_flows %}
                        <tr>
                            <td class="text-truncate" style="max-width: 120px;">{{ flow.session_id }}</td>
                            <td>
                                <div class="path-sequence">
                                    {% for path in flow.path_sequence %}
                                    <span class="badge bg-secondary me-1">{{ path }}</span>
                                    {% endfor %}
                                </div>
                            </td>
                            <td>{{ flow.duration }}s</td>
                            <td>{{ flow.exit_page }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Sankey Diagram Script -->
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Sample Sankey diagram data - replace with your actual data
    const sankeyData = {
        nodes: [
            { name: "Home" },
            { name: "Products" },
            { name: "Pricing" },
            { name: "Checkout" },
            { name: "Contact" }
        ],
        links: [
            { source: 0, target: 1, value: 150 },
            { source: 0, target: 2, value: 80 },
            { source: 1, target: 3, value: 40 },
            { source: 2, target: 3, value: 30 },
            { source: 1, target: 4, value: 20 }
        ]
    };

    // Draw Sankey diagram
    const width = document.getElementById('sankeyDiagram').clientWidth;
    const height = 400;
    
    const svg = d3.select("#sankeyDiagram")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("viewBox", [0, 0, width, height]);
    
    // Add your Sankey diagram drawing code here
    // (Implementation depends on your specific visualization library)
});
</script>