{% extends 'base.html' %}
{% load static %}

{% block title %}Scroll Depth Analytics{% endblock %}

{% block content %}
<div class="space-y-8">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-white">Scroll Depth Analytics</h1>
            <p class="text-white/50 mt-1">{% if monitored_url %}Tracking {{ monitored_url.name }}{% else %}How far users scroll on your pages{% endif %}</p>
        </div>
        
        <div class="flex items-center space-x-2">
            <!-- URL Selector -->
            {% if all_monitored_urls %}
            <select id="urlSelector" class="glass-effect rounded-lg px-4 py-2 text-sm font-medium text-white" onchange="if(this.value) window.location.href=this.value">
                <option value="{% url 'monitor:analytics_scroll' %}?days={{ days }}">All URLs</option>
                {% for url in all_monitored_urls %}
                <option value="{% url 'monitor:analytics_scroll_url' url.id %}?days={{ days }}" {% if monitored_url and monitored_url.id == url.id %}selected{% endif %}>
                    {{ url.name|truncatechars:30 }}
                </option>
                {% endfor %}
            </select>
            {% endif %}
            
            <select id="timeRange" class="glass-effect rounded-lg px-4 py-2 text-sm font-medium text-white" onchange="updateTimeRange(this.value)">
                <option value="7" {% if days == 7 %}selected{% endif %}>Last 7 days</option>
                <option value="30" {% if days == 30 %}selected{% endif %}>Last 30 days</option>
            </select>
        </div>
    </div>

    <div class="glass-effect rounded-xl p-2 flex flex-wrap gap-2">
        <a href="{% url 'monitor:analytics_overview' %}{% if monitored_url %}{{ monitored_url.id }}/{% endif %}" class="px-4 py-2 rounded-lg text-white/70 hover:bg-white/5 text-sm font-medium transition-all">Overview</a>
        <a href="{% url 'monitor:analytics_heatmap' %}{% if monitored_url %}{{ monitored_url.id }}/{% endif %}" class="px-4 py-2 rounded-lg text-white/70 hover:bg-white/5 text-sm font-medium transition-all">Heatmaps</a>
        <a href="{% url 'monitor:analytics_geolocation' %}{% if monitored_url %}{{ monitored_url.id }}/{% endif %}" class="px-4 py-2 rounded-lg text-white/70 hover:bg-white/5 text-sm font-medium transition-all">Geolocation</a>
        <a href="{% url 'monitor:analytics_performance' %}{% if monitored_url %}{{ monitored_url.id }}/{% endif %}" class="px-4 py-2 rounded-lg text-white/70 hover:bg-white/5 text-sm font-medium transition-all">Performance</a>
        <a href="{% url 'monitor:analytics_scroll' %}{% if monitored_url %}{{ monitored_url.id }}/{% endif %}" class="px-4 py-2 rounded-lg bg-white text-black text-sm font-medium">Scroll Depth</a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Scroll Depth Distribution -->
        <div class="glass-effect rounded-xl p-6">
            <h2 class="text-xl font-bold mb-4">Scroll Depth Distribution</h2>
            <div class="space-y-3">
                {% for range, count in scroll_ranges.items %}
                <div class="flex items-center space-x-3">
                    <span class="text-sm font-medium text-white/70 w-20">{{ range }}</span>
                    <div class="flex-1">
                        <div class="w-full bg-white/10 rounded-full h-6 overflow-hidden">
                            {% if count > 0 %}
                            {% widthratio count max_count 100 as bar_width %}
                            <div class="bg-gradient-to-r from-white/90 to-white/60 h-6 rounded-full flex items-center justify-end px-2" 
                                 style="width: {{ bar_width }}%;">
                                <span class="text-xs font-bold text-black">{{ count }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Scroll Over Time -->
        <div class="glass-effect rounded-xl p-6">
            <h2 class="text-xl font-bold mb-4">Average Scroll Over Time</h2>
            <div class="space-y-3">
                {% for day in scroll_over_time %}
                <div class="p-3 rounded-lg bg-white/5">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-white">{{ day.date }}</span>
                        <span class="text-xs text-white/50">{{ day.total_views }} views</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="flex-1">
                            <div class="w-full bg-white/10 rounded-full h-3 overflow-hidden">
                                <div class="bg-gradient-to-r from-white/90 to-white/60 h-3 rounded-full" 
                                     style="width: {{ day.avg_scroll|floatformat:0 }}%"></div>
                            </div>
                        </div>
                        <span class="text-sm font-bold text-white">{{ day.avg_scroll|floatformat:0 }}%</span>
                    </div>
                </div>
                {% empty %}
                <p class="text-white/50 text-center py-4">No data available</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="glass-effect rounded-xl p-6">
        <h2 class="text-xl font-bold mb-4">Scroll Depth by Page</h2>
        <div class="space-y-4">
            {% for page in scroll_by_page %}
            <div class="p-4 rounded-lg bg-white/5">
                <div class="flex items-center justify-between mb-3">
                    <p class="text-sm font-medium text-white truncate flex-1">{{ page.page_url }}</p>
                    <span class="text-xs text-white/50 ml-4">{{ page.views }} views</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex-1">
                        <div class="w-full bg-white/10 rounded-full h-3 overflow-hidden">
                            <div class="bg-gradient-to-r from-white/90 to-white/60 h-3 rounded-full transition-all duration-500" style="width: {{ page.avg_scroll|floatformat:0 }}%"></div>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold text-white">{{ page.avg_scroll|floatformat:0 }}%</p>
                        <p class="text-xs text-white/50">{{ page.scrolled_to_bottom }} to bottom</p>
                    </div>
                </div>
            </div>
            {% empty %}
            <p class="text-white/50 text-center py-8">No scroll data available</p>
            {% endfor %}
        </div>
    </div>
</div>

<script>
function updateTimeRange(days) {
    const urlSelector = document.getElementById('urlSelector');
    const currentUrl = urlSelector ? urlSelector.value.split('?')[0] : window.location.pathname;
    window.location.href = currentUrl + '?days=' + days;
}
</script>
{% endblock %}
