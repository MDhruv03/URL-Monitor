{% extends 'base.html' %}
{% load static %}

{% block title %}Scroll Depth Analytics{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <h1 class="text-3xl font-bold text-white">ðŸ“œ Scroll Depth Analytics</h1>
            <p class="text-white/50 mt-1">{% if monitored_url %}{{ monitored_url.name }}{% else %}Measure user engagement through scroll behavior{% endif %}</p>
        </div>
        
        <div class="flex items-center space-x-2">
            {% if all_monitored_urls %}
            <select id="urlSelector" class="glass-effect rounded-lg px-4 py-2 text-sm font-medium text-white cursor-pointer hover:bg-white/5 transition-all" onchange="if(this.value) window.location.href=this.value">
                <option value="{% url 'monitor:analytics_scroll' %}?days={{ days }}">All URLs</option>
                {% for url in all_monitored_urls %}
                <option value="{% url 'monitor:analytics_scroll_url' url.id %}?days={{ days }}" {% if monitored_url and monitored_url.id == url.id %}selected{% endif %}>
                    {{ url.name|truncatechars:30 }}
                </option>
                {% endfor %}
            </select>
            {% endif %}
            
            <select id="timeRange" class="glass-effect rounded-lg px-4 py-2 text-sm font-medium text-white cursor-pointer hover:bg-white/5 transition-all" onchange="updateTimeRange(this.value)">
                <option value="7" {% if days == 7 %}selected{% endif %}>Last 7 days</option>
                <option value="30" {% if days == 30 %}selected{% endif %}>Last 30 days</option>
                <option value="90" {% if days == 90 %}selected{% endif %}>Last 90 days</option>
            </select>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="glass-effect rounded-xl p-2 flex flex-wrap gap-2">
        <a href="{% url 'monitor:analytics_overview' %}{% if monitored_url %}{{ monitored_url.id }}/{% endif %}" class="px-4 py-2 rounded-lg text-white/70 hover:bg-white/5 text-sm font-medium transition-all">Overview</a>
        <a href="{% url 'monitor:analytics_heatmap' %}{% if monitored_url %}{{ monitored_url.id }}/{% endif %}" class="px-4 py-2 rounded-lg text-white/70 hover:bg-white/5 text-sm font-medium transition-all">Heatmaps</a>
        <a href="{% url 'monitor:analytics_geolocation' %}{% if monitored_url %}{{ monitored_url.id }}/{% endif %}" class="px-4 py-2 rounded-lg text-white/70 hover:bg-white/5 text-sm font-medium transition-all">Geolocation</a>
        <a href="{% url 'monitor:analytics_performance' %}{% if monitored_url %}{{ monitored_url.id }}/{% endif %}" class="px-4 py-2 rounded-lg text-white/70 hover:bg-white/5 text-sm font-medium transition-all">Performance</a>
        <a href="{% url 'monitor:analytics_scroll' %}{% if monitored_url %}{{ monitored_url.id }}/{% endif %}" class="px-4 py-2 rounded-lg bg-white text-black text-sm font-medium shadow-lg">Scroll Depth</a>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Scroll Depth Distribution -->
        <div class="lg:col-span-2 glass-effect rounded-xl p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-white">Scroll Depth Distribution</h2>
                <span class="text-sm text-white/50">How far users scroll</span>
            </div>
            <div class="space-y-2">
                {% for range, count in scroll_ranges.items %}
                <div class="flex items-center space-x-3 group hover:bg-white/5 rounded-lg p-2 transition-all">
                    <span class="text-sm font-medium text-white/90 w-24 shrink-0">{{ range }}</span>
                    <div class="flex-1">
                        <div class="w-full bg-white/10 rounded-full h-8 overflow-hidden">
                            {% if count > 0 %}
                            {% widthratio count max_count 100 as bar_width %}
                            <div class="bg-gradient-to-r from-cyan-400 to-blue-500 h-8 rounded-full flex items-center justify-end px-3 transition-all duration-300 hover:from-cyan-300 hover:to-blue-400" 
                                 style="width: {{ bar_width }}%;">
                                <span class="text-xs font-bold text-white drop-shadow-lg">{{ count }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Average Scroll Stats -->
        <div class="glass-effect rounded-xl p-6">
            <h2 class="text-xl font-bold text-white mb-6">Key Metrics</h2>
            <div class="space-y-4">
                {% with total_views=scroll_by_page|length %}
                <div class="p-4 rounded-lg bg-gradient-to-br from-cyan-500/20 to-blue-500/20 border border-cyan-500/30">
                    <p class="text-sm text-white/70 mb-1">Total Pages</p>
                    <p class="text-3xl font-bold text-white">{{ total_views }}</p>
                </div>
                {% endwith %}
                
                {% if scroll_by_page %}
                <div class="p-4 rounded-lg bg-gradient-to-br from-purple-500/20 to-pink-500/20 border border-purple-500/30">
                    <p class="text-sm text-white/70 mb-1">Avg Scroll Depth</p>
                    {% with avg_all=scroll_by_page|first %}
                    <p class="text-3xl font-bold text-white">{{ avg_all.avg_scroll|floatformat:0 }}%</p>
                    {% endwith %}
                </div>
                {% endif %}
                
                <div class="p-4 rounded-lg bg-gradient-to-br from-green-500/20 to-emerald-500/20 border border-green-500/30">
                    <p class="text-sm text-white/70 mb-1">Deep Scrollers</p>
                    <p class="text-3xl font-bold text-white">{{ scroll_ranges.90-100% }}</p>
                    <p class="text-xs text-white/50 mt-1">Reached 90%+</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scroll Over Time Chart -->
    <div class="glass-effect rounded-xl p-6">
        <h2 class="text-xl font-bold text-white mb-4">ðŸ“ˆ Scroll Depth Trend</h2>
        <div class="h-64 overflow-x-auto">
            <div class="flex items-end space-x-2 h-full min-w-max">
                {% for day in scroll_over_time %}
                <div class="flex flex-col items-center space-y-2 group">
                    <div class="h-48 w-12 bg-white/10 rounded-t-lg overflow-hidden flex flex-col-reverse relative group-hover:bg-white/20 transition-all">
                        <div class="bg-gradient-to-t from-cyan-500 to-blue-500 w-full rounded-t-lg transition-all duration-300 group-hover:from-cyan-400 group-hover:to-blue-400 relative" 
                             style="height: {{ day.avg_scroll|floatformat:0 }}%;">
                            <span class="absolute -top-6 left-1/2 transform -translate-x-1/2 text-xs font-bold text-white opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
                                {{ day.avg_scroll|floatformat:0 }}%
                            </span>
                        </div>
                    </div>
                    <div class="text-center">
                        <p class="text-xs font-medium text-white/90">{{ day.date|date:"M d" }}</p>
                        <p class="text-xs text-white/50">{{ day.total_views }}</p>
                    </div>
                </div>
                {% empty %}
                <p class="text-white/50 text-center w-full py-8">No data available for the selected period</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Scroll Depth by Page -->
    <div class="glass-effect rounded-xl p-6">
        <h2 class="text-xl font-bold text-white mb-4">ðŸ“„ Scroll Depth by Page</h2>
        <div class="space-y-3">
            {% for page in scroll_by_page %}
            <div class="p-4 rounded-lg bg-white/5 hover:bg-white/10 transition-all group">
                <div class="flex items-center justify-between mb-3">
                    <p class="text-sm font-medium text-white truncate flex-1 group-hover:text-cyan-400 transition-colors">{{ page.page_url }}</p>
                    <span class="text-xs text-white/50 ml-4 shrink-0">{{ page.views }} views</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex-1">
                        <div class="w-full bg-white/10 rounded-full h-4 overflow-hidden">
                            <div class="bg-gradient-to-r from-cyan-400 to-blue-500 h-4 rounded-full transition-all duration-500" 
                                 style="width: {{ page.avg_scroll|floatformat:0 }}%"></div>
                        </div>
                    </div>
                    <div class="text-right shrink-0">
                        <p class="text-lg font-bold text-white">{{ page.avg_scroll|floatformat:0 }}%</p>
                        <p class="text-xs text-green-400">{{ page.scrolled_to_bottom }} reached end</p>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-12">
                <div class="text-6xl mb-4">ðŸ“œ</div>
                <p class="text-white/50 text-lg">No scroll data available</p>
                <p class="text-white/30 text-sm mt-2">Data will appear once users interact with your tracked pages</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
function updateTimeRange(days) {
    const urlSelector = document.getElementById('urlSelector');
    const currentUrl = urlSelector ? urlSelector.value.split('?')[0] : window.location.pathname;
    window.location.href = currentUrl + '?days=' + days;
}
</script>
{% endblock %}
